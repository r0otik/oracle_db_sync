# Синхронизация Oracle

* Минимальные усилия для добавления новой таблицы в синхронизацию. Добавить одну строку в config.yml (в подавляющем большинстве случаев)
* Возможность бэкапа таблицы перед тем, как вносить в нее изменения
* Ротация бэкап файлов
* Возможность актуализации не только путем полного перезалива таблицы (TRUNCATE -> INSERT), но и путем нахождения различий в таблицах и вставки только недостающих
* Возможность указания полей, которые будут ключом при поиске различий
* При полном перезаливе таблицы, если INSERT завершился ошибкой, например из-за того, что тип данных локальной таблицы не вмещает данные из удаленной, таблица будет возвращена в исходное состояние, как до начала синхронизации
* Возможность настроить синхронизацию не только через dblink
* Автоматическое исключение идентити-столбцов перед вставкой
* Возможность "смаппить" столбцы, т.е. локальная таблица именами столбцов не должна полностью соответствовать удаленной
* Возможность включать не все столбцы в синхронизацию
* При отсутствии таблицы в локальной БД она будет создана скриптом самостоятельно

## Общая структура config.yml

Файл конфигурации состоит из трёх логических разделов:

```yaml

General:
Connections:
Sync:
```

Каждый раздел описан ниже.


---

## Раздел General

Глобальные параметры работы скрипта.

```yaml

General:
  backup_path: ./backup
  log_file: ./dbSync.log
```

### Параметры

| Параметр | Обязателен | Описание |
|----|----|----|
| `backup_path` | нет | Каталог для хранения CSV-бэкапов таблиц перед синхронизацией. Если не указан, используется `./backup`. |
| `log_file` | да | Путь до файла логов |
| `log_level` | нет | Уровень логирования, по умолчанию используется INFO |


---

## Раздел Connections

В этом разделе описываются **подключения к базам данных**, а также логические подключения через `dblink`.

```yaml

Connections:
  pl_db:
    db_user: USERNAME
    db_password: testing123
    db_host: myhostname.test.local
    db_name: ORCL

  old:
    dblink: True
    scheme_name: newschema
    postfix: old_database
    avail_from: pl_db

  prod:
    dblink: True
    postfix: prod
    avail_from: pl_db
```

### Обычное подключение к БД

Используется для прямого подключения к Oracle.

```yaml

pl_db:
  db_user: USERNAME
  db_password: PASSWORD
  db_host: hostname
  db_name: SERVICE_NAME
```

#### Параметры

| Параметр | Обязателен | Описание |
|----|----|----|
| `db_user` | да | Пользователь Oracle |
| `db_password` | да | Пароль |
| `db_host` | да | Хост БД |
| `db_name` | да | Service Name |
| `db_port` | нет | Порт, по умолчанию `1521` |


---

### Подключение через DBLINK

Используется, если таблицы доступны **только через dblink** из другой БД.

```yaml

old:
  dblink: True
  scheme_name: newschema
  postfix: old_database
  avail_from: pl_db
```

#### Как это работает

* Скрипт подключается к БД, указанной в `avail_from`
* Таблицы выбираются как `SCHEMA.TABLE@DBLINK`

#### Параметры

| Параметр | Обязателен | Описание |
|----|----|----|
| `dblink` | да | Всегда `True` |
| `avail_from` | да | Имя подключения, через которое доступен dblink |
| `scheme_name` | нет | Схема таблиц |
| `postfix` | нет | Имя dblink |


---

## Раздел Sync

Описывает **наборы синхронизаций**.

Кто знаком с ansible - довольно очевидная аналогия с операциями внутри сценария.

```yaml

Sync:
  prod_sync_diff:
```


---

## Описание задачи синхронизации

```yaml

prod_sync_diff:
  local_db: pl_db
  remote_db: prod
  sync_type: diff
  backup: True
  rotate: 1
  tables:
    - STREETS_TEST: STREETS
      map_columns:
        ST_NAME: STREET_NAME
        ST_ENG: STREET_NAME_ENG
      diff_key:
        - ST_NAME
        - ST_ENG
        - CITY_ID
```



| Параметр | Обязателен | Описание |
|----|----|----|
| `local_db` | да | Соединение, которое будет использоваться для внесения изменений. Должно быть определено в *Connections* |
| `remote_db` | да | Соединение, которое будет использоваться для получения эталонной информации. Должно быть определено в *Connections* |
| `sycn_type` | да | Тип синхронизации (см. ниже) |
| `backup` | нет | Делается ли резервная копия локальной таблицы перед внесением в нее изменений |
| `rotate` | нет | Ротация сделанных резервных копий. Работает только при backup=True |
| `table` | да | Список синхронизируемых таблиц в формате:- <имя_локальной>: <имя_эталонной> |

#### Типы синхронизации

**truncate** Полная перезаливка таблицы. TRUNCATE -> INSERT

**diff** Инкрементальная синхронизация по ключу.


Внутри "задачи" конкретной таблицы можно указать необязательные параметры:

| Параметр | Описание |
|----|----|
| `map_columns` | Словарь, содержащий пары <локальный_столбец>: <удаленный_столбец> |
| `only_mapped` | Если True, то в выгрузке/сравнении и тд будут участвовать только столбцы, перечисленные в `map_columns` |
| `diff_key` | Будет работать только при sync_type: diff, содержит список имен столбцов (локальных имен!), которые будут ключом для поиска расхождений. По умолчанию в ключе участвуют все столбцы. |


---

## Рекомендации

* Использовать UPPERCASE для имён таблиц и колонок
* Проверять конфиг перед добавлением в cron
* Включать backup


---

## Запуск

Есть несколько ключей, которые можно указывать при ручном запуске скрипта:

| Ключ | Описание | По умолч |
|----|----|----|
| `-i, --input` | "Входная таблица", т.е. та, которая будет использована как эталонная | - |
| `-o, --output` | "Выходная таблица", в которую будут вносится изменения | - |
| `-l, --local-conn` | Имя подключения к локальной БД, должен быть определен в разделе *Connections* файла config.yml | pl_db |
| `-r, --remote-conn` | Имя подключения к удаленной БД, должен быть определен в разделе *Connections* файла config.yml | prod |
| `-m, --method-sync` | Метод синхронизации | truncate |
| `-s, --show-only` | Показать результаты сравнения таблиц без внесения изменений в БД. Если определены параметры выше, будут показаны результаты сравнения указанной таблицы. Если нет - всех таблиц в конфиге | no |
| `-ll, --log-level` | Уровень логирования. Приоритет уровня указанного тут, выше указанного в конфиге | INFO |

```bash

cd /data/cdrs/scripts/dbSync/
python3 ./dbSync.py -o STREETS_TEST -i STREETS -m diff
```

```bash
python3 ./dbSync.py -o CMDOFF_VC_APN -i VC_APN -r old -s yes
```

При вызове скрипта для таблицы через ключи маппинг столбцов и тд пока что не предусмотрен, т.е. таблицы должны быть идентичны.


---

## Что планируется добавить:

* При генерации DDL таблицы (используется если таблицы нет БД) используется простая форма без CONSTAINST и тд. Функционал есть, но пока отключен
* ~~Использовать logging для вывода сообщений, введение уровней логирования и тд~~
* ~~Уменьшить потребление памяти~~
* ~~Перенести некоторые вычисления в БД~~

  Косяки, выявленные в процессе эксплуатации, есесна будут исправляться
